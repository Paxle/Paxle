#set( $configAdmin = $manager.getService( "org.osgi.service.cm.ConfigurationAdmin"))
#set( $metaTypeService = $manager.getService( "org.osgi.service.metatype.MetaTypeService"))

#if( $metaTypeService && $configAdmin)
	<h3>Configuration Management #if($paramParser.getString("viewImportedConfig"))- Import#end</h3>
	#if( $paramParser.getString("bundleID") && $paramParser.getString("pid"))
		## the service-PID for which the configuration should be displayed
		#set($PID = $paramParser.getString("pid"))
		
		## the bundle the give service belongs to
		#set($bundleID = $paramParser.getString("bundleID"))		
		#set($bundle = $manager.getBundle($mathTool.toInteger($bundleID)))
		
		## searching for metatype info
		#set($metaType = $metaTypeService.getMetaTypeInformation($bundle))
		#if($metaType)
			#if($bundle.getBundleId() == $metaType.getBundle().getBundleId())
    			#set($ocd = $metaType.getObjectClassDefinition($PID, "en"))
    			#if($ocd)
    				<p>
						<p>
							<img src="?settings=config&amp;bundleID=$bundleID&amp;pid=$PID&amp;getImage=" alt="${ocd.getName()}"/>
        					<strong>$ocd.getName()</strong>&nbsp;[Bundle <a href="bundle?bundleID=$bundleID&amp;action=details">$bundleID</a>]</br>
							<div class="descriptionText">$ocd.getDescription()</div>
						</p>						
						    					
						#if($paramParser.getString("viewImportedConfig"))
							<div>Uploaded Configuration values that could be imported for this service</div>
							
							## getting configuration properties that can be imported
							#set($configProps = ${importedConfigProps.get($PID)})
						#else
							<div>The current configuration of this service:</div>
							
							## getting the current configuration
							#set($configProps = $configAdmin.getConfiguration($PID,${bundle.getLocation()}).getProperties())
						#end
    					
    					## getting the configuration attributes
    					#set($attributes = $ocd.getAttributeDefinitions(-1))
    					#if($attributes)
							<form action="">
								<input type="hidden" name="settings" value="config"/>
								<input type="hidden" name="pid" value="$PID"/>
								<input type="hidden" name="bundleID" value="${bundle.getBundleId()}"/>
								
                            	<table>
                            	<tr>
                            		<th>Name</th>
        							<th>Type</th>
                            		<th>Value</th>
    								<th>Description</th>
                            	</tr>
                            	#foreach($attribute in $attributes)
    								#set($attributeID = ${attribute.getID()})								
    								#set($attribValue = ${settingsView.getPropertyValue($configProps,$attribute)})
    								#set($attribType = ${dataTypes.get($attribute.getType())})
									#set($optionLabels = ${attribute.getOptionLabels()})
									#set($optionValues = ${attribute.getOptionValues()})
									#set($attribCardinality = ${attribute.getCardinality()})
    								
                            		<tr class="$color">
                            			<td>$attribute.getName()</td>
        								<td><tt>$attribType</tt></td>
                            			<td>
											#if($optionLabels && $listTool.size($optionLabels) > 0)
												<select name="$attributeID"
												#set($numOptions = $listTool.size($optionLabels))
												#if($attribCardinality == 0 || $numOptions == 1)
													size="1"
												#else
													multiple="multiple"
													size="#if($attribCardinality > 5)5#else${numOptions}#end"
												#end
												>
												#foreach($optionLabel in $optionLabels)
													#set($idx = $velocityCount - 1)
													#set($optionValue = ${listTool.get($optionValues,$idx)})													
													<option value="$optionValue"
														#if(${listTool.isArray($attribValue)})
															#if(${listTool.contains($attribValue,$optionValue)})selected="selected"#end
														#else
															#if($optionValue==$attribValue)selected="selected"#end
														#end
													>$optionLabel</option>                                               
												#end
												</select>
    										#else 
        										#if($attribType == "Boolean")
    												<input type="radio" name="$attributeID" id="true$attributeID" value="true" #if($attribValue)checked="checked"#end>
    												<label for="true$attributeID">Yes</label>
    												&nbsp;
    												<input type="radio" name="$attributeID" id="false$attributeID" value="false" #if(!$attribValue)checked="checked"#end>
    												<label for="false$attributeID">No</label> 
        										#else
        											<input type="#if($attributeID.toLowerCase().contains("password"))password#else{text}#end" name="$attributeID" value="$!attribValue"/>
        										#end	
											#end
    									</td>
    									<td class="descriptionText">
    										${attribute.getDescription()}
    										#if($attributeID.toLowerCase().contains("password"))
    											<p><em>Be aware that this password is being saved unencrypted.</em></p>
    										#end
    									</td>
                            		</tr>                            		
                            	#end
                            	</table>
								#if(!$paramParser.getString("viewImportedConfig"))
									<input type="submit" name="doEditConfig" value="Change"/>									
									<input type="submit" name="doExportConfig" value="Export"/>
								#else
									<input type="submit" name="doImportConfig" value="Import"/>
									<input type="hidden" name="viewImportedConfig"/>
								#end
								<a class="button" href="?settings=config#if($paramParser.getString("viewImportedConfig"))&amp;viewImportedConfig=#end">Back to Overview</a>
							</form>
    					#end
    					<hr/>
    				</p>
				#end
				
				#if($PID == "org.paxle.gui.IStyleManager")
					<b>Upload new styles jar</b>
                    <form enctype="multipart/form-data" method="post" action="?doInstallStyle=">
                    	<p>
                    		<input type="file" name="styleJar" size="60" />
                    		<input type="submit" name="doUpload" value="Install" />
                    	</p>
                    </form>
				#end
		    #end	
		#end
	#else 
		#if($paramParser.getString("viewImportedConfig"))
			#if(${importedConfigProps.size()} > 0)
				<div class="descriptionText">The uploaded configuration file contains settings for the following services:</div>
			#else
				<div class="descriptionText" style="color:red;">No settings left to import.</div>
			#end
		#else
			<div class="descriptionText">The following list shows all services installed on the system that can be configured by the user:</div>
		#end
		<table>
		<tr>
			<th>&nbsp;</th>
			<th>Name</th>
			<th>Description</th>
		</tr>
		#set($color = $alternatorTool.auto('r1','r2'))
		
    	## loop through each bundle to see if there are any metatypes	
    	#foreach($bundle in $manager.getBundles())
    		#set($metaType = $metaTypeService.getMetaTypeInformation($bundle))
    		#if($metaType)
				#if(${bundle.getBundleId()} == ${metaType.getBundle().getBundleId()})					
        			## get the PIDs of all managed services
        			#set($PIDs = ${metaType.getPids()})
        			#if($PIDs)
        				## loop through all managed services and fetch the
        				## corresponding ObjectClassDefinitions
        				#foreach($PID in $PIDs)
        					#set($ocd = $metaType.getObjectClassDefinition($PID, "en"))
        					#if($ocd && (!$paramParser.getString("viewImportedConfig") || ${importedConfigProps.containsKey($PID)}))
    							<tr class="$color">
									<td><img src="?settings=config&amp;bundleID=${bundle.getBundleId()}&amp;pid=$PID&amp;getImage=" alt="${ocd.getName()}"/></td>
    								<td>
										<a href="?settings=config&amp;bundleID=${bundle.getBundleId()}&amp;pid=$PID#if($paramParser.getString("viewImportedConfig"))&amp;viewImportedConfig=#end">${ocd.getName()}</a><br/>
										<tt>[$PID]</tt>
									</td>
    								<td class="descriptionText">${ocd.getDescription()}</td>
    							</tr>							
        					#end
        				#end
        			#end	
					
					#*
        			## get the PIDs of all managed services factories
        			#set($PIDs = $metaType.getFactoryPids())
        			#if($PIDs)					
        				## loop through all managed services and fetch the
        				## corresponding ObjectClassDefinitions
        				#foreach($PID in $PIDs)
        					#set($ocd = $metaType.getObjectClassDefinition($PID, "en"))
        					#if($ocd)
    							<tr class="$color">
    								<td>$ocd.getName()</td>
    								<td>$PID</td>
    								<td><a href="?bundleID=$bundle.getBundleId()&amp;pid=$PID&amp;factory=">View</a></td>
    							</tr>							
        					#end
        				#end
        			#end		
					*#
				#end
    		#end
		#end
		</table>
		
		#if(!$paramParser.getString("viewImportedConfig"))
		<p>
			<b>Export Configuration</b>
			<div class="descriptionText">
				Use this function to export the configuration of all services listed above into a zip file.
			</div>
		    <form action="?settings=config">
           	<p>
           		<input type="submit" name="doExportConfig" value="Export Configuration" />
           	</p>
			</form>	
		</p>
				
		<p>
    		<b>Import Configuration</b>
			<div class="descriptionText">
				Use this function to import the configuration of services you have previously exported.
			</div>
            <form enctype="multipart/form-data" method="post" action="?settings=config&amp;viewImportedConfig=">
            	<p>
            		<input type="file" name="configFile" size="60" />
            		<input type="submit" name="doUpload" value="Upload" />
            	</p>
            </form>	
		</p>
		#end
	#end
#else 
	#if(!$configAdmin)<div class="bundleNotInstalled">Configuration Administration bundle not installed!</div>#end
	#if(!$metaTypeService)<div class="bundleNotInstalled">Metatype bundle not installed!</div>#end
#end